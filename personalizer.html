<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Azure Cognitive Services - Anomaly Detection</title>
    <link rel="stylesheet" href="/res/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/python.min.js"></script>
    
  </head>
  <body>
  <section class="main-content columns is-fullheight">
    <aside class="menu column is-2 is-narrow-mobile is-fullheight section">
      <p class="menu-label">
        Decision APIs
      </p>
      <ul class="menu-list">
        <li><a href="anomaly.html">Anomaly Detector</a></li>
        <li><a href="personalizer.html" class="is-active">Personalizer</a></li>
      </ul>
      <p class="menu-label">
        Language APIs
      </p>
      <ul class="menu-list">
        <li><a class="has-text-grey-lighter">Language Understanding</a></li>
        <li><a class="has-text-grey-lighter">Q&amp;A Maker</a></li>
        <li><a href="text_analytics.html">Text Analytics</a></li>
        <li><a class="has-text-grey-lighter">Translator</a></li>
      </ul>
      <p class="menu-label">
          Speech APIs
      </p>
      <ul class="menu-list">
          <li><a class="has-text-grey-lighter">Speech to Text</a></li>
          <li><a class="has-text-grey-lighter">Text to Speech</a></li>
          <li><a class="has-text-grey-lighter">Speech Translation</a></li>
          <li><a class="has-text-grey-lighter">Speaker Recognition</a></li>
      </ul>
      <p class="menu-label">
      Vision APIs
      </p>
        <ul class="menu-list">
          <li><a class="has-text-grey-lighter">Computer Vision</a></li>
          <li><a class="has-text-grey-lighter">Custom Vision</a></li>
          <li><a class="has-text-grey-lighter">Face API</a></li>
        </ul>
    </aside>
    <div class="container column is-10">
        <div class="section">
            <h1 class="title">
                Personalizer
            </h1>

            <div class="columns">
              <div class="column">
                <p>
                  This experiment uses <a href="https://github.com/tonybaloney/cognitive-kitchen-sink/blob/main/api/data/koala.ipynb">a dataset</a> of sightings of wild Koalas in Australia. 
                  This dataset captured the date and time of the sighting, along with the species of the tree the koala was in. Koala will spend a lot of their day sleeping and the remainder snacking on their favourite food-- gum (Eucalyptus) leaves.
                </p>
                <p>
                  The Australian department of agriculture lists 531 species of Eucalyptus in the <a href="https://www.agriculture.gov.au/abares/forestsaustralia/forest-data-maps-and-tools/data-workbooks#lists-of-forest-species-and-ecological-communities-from-australias-state-of-the-forests-report-2018">catalogue of Australian Forest Flora.</a>
                </p>
                <p>
                  In collaboration with the <a href="https://www.anbg.gov.au/gardens/">Australian National Botanic Garden</a> and other research institutions, the Atlas of Living Australia is a huge online database of records of sightings, species lists and observational records.
                  The Koala Sightings data was collated and a list of the species that the koala were spotted in was submitted to the ALA. This produced a new dataset, a record of the 56 species those koala sightings were in.
                </p>
            </div>
              <div class="column is-one-third"><figure class="image is-3by4">
                <img src="/res/img/archie-carlson-u6a07N1J5D4-unsplash-2.jpg" alt="Koala in tree.">
              </figure></div>
            </div>

            <p>
              <i>Photo by <a href="https://unsplash.com/@archiecarlson?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Archie Carlson</a> on <a href="https://unsplash.com/s/photos/koala?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a>.</i>
              <i>The <a href="https://github.com/tonybaloney/cognitive-kitchen-sink/blob/main/api/Personalizer/__init__.py">Source Code</a> is open source and licensed under MIT. 
                <a href="https://www.ala.org.au/terms-of-use/">Data</a> from the Atlas of Living Australia, distributed with attribution under <a href="https://creativecommons.org/licenses/by/3.0/au/deed.en">Attribution 3.0 Australia (CC BY 3.0 AU)</a>. </i>
            </p>

       </div>
            <div class="section">
              <h2 class="title">Azure Functions Source Code</h2>
              <pre><code class="language-python">
import logging
import os
from datetime import datetime
from azure.core.exceptions import HttpResponseError
from azure.ai.anomalydetector import AnomalyDetectorClient
from azure.ai.anomalydetector.models import DetectRequest, TimeSeriesPoint, TimeGranularity
from azure.core.credentials import AzureKeyCredential
import pandas as pd

import azure.functions as func


def main(req: func.HttpRequest) -> func.HttpResponse:
    try:
        client = AnomalyDetectorClient(AzureKeyCredential(os.environ["ANOMALY_DETECTOR_KEY"]), os.environ["ANOMALY_DETECTOR_ENDPOINT"])

        try:
            height_of_koala = int(req.params.get('height_of_koala'))
            height_of_tree = int(req.params.get('height_of_tree'))
            if height_of_tree == 0:
                raise ValueError
        except ValueError as e:
            logging.exception(e)
            return func.HttpResponse(str(e), status_code=500)

        df = pd.read_csv(os.path.join("data", "koala-survey-sightings-data.csv"), encoding='utf-8', parse_dates=[['Date', 'Time']])

        # Drop entries with no height recorded.
        df.dropna(subset=['HeightOfKoalaInTree_m', 'HeightOfTree_m'], inplace=True)
        # Drop entries recorded at the exact same time
        df.drop_duplicates(subset = ["Date_Time"], inplace=True)
        # Calculate the percentage of the tree the Koala has climbed
        df['PercentageHeightClimbed'] = df['HeightOfKoalaInTree_m'] / df['HeightOfTree_m']
        # Turn into a timeseries
        series = [TimeSeriesPoint(timestamp=row[0], value=row[1]) for _, row in df[['Date_Time', 'PercentageHeightClimbed']].sort_values(by=['Date_Time']).iterrows()]
        
        # Add the user input
        series.append(TimeSeriesPoint(timestamp=datetime.now(), value=height_of_koala/height_of_tree))
        request = DetectRequest(series=series, granularity=TimeGranularity.NONE)
    
        response = client.detect_last_point(request)
    except HttpResponseError as e:
        msg = 'Error code: {} '.format(e.error.code) + 'Error message: {}'.format(e.error.message)
        logging.error(msg)
        return func.HttpResponse('Error code: {} '.format(e.error.code), status_code=500)
    except Exception as e:
        logging.exception(e)
        return func.HttpResponse(str(e), status_code=500)

    if response.is_anomaly:
        return func.HttpResponse(
            "Anomaly",
            status_code=200
        )
    else:
        return func.HttpResponse(
            "OK",
            status_code=200
        )
                
              </code></pre>
              </div>
          </div>
            <script>
              function verify() {
                document.getElementById("message-box").style.display = 'none';

                var height_of_koala = parseInt(document.getElementById("height_of_koala").value);
                var height_of_tree = parseInt(document.getElementById("height_of_tree").value);

                var xhr = new XMLHttpRequest();
                xhr.open(
                  "GET",
                  "https://white-pebble-0101a6a10.azurestaticapps.net/api/AnomalyDetection?height_of_koala="+height_of_koala+"&height_of_tree="+height_of_tree,
                  true
                );
                xhr.send();
                document.getElementById('submit-button').classList.add('is-loading');
                xhr.onload = function () {
                  document.getElementById('submit-button').classList.remove('is-loading');
                  document.getElementById("message-box").style.display = 'block';
                  document.getElementById("message-box").className = 'message';

                  if (this.status === 500){
                    document.getElementById('message-box').classList.add('is-danger');
                    document.getElementById("message-text").innerText = "Error with data";
                  } else if (this.status == 400){
                    document.getElementById('message-box').classList.add('is-warning');
                    document.getElementById("message-text").innerText = this.responseText;
                  } else {
                    document.getElementById('message-box').classList.add('is-success');
                    document.getElementById("message-text").innerText = this.responseText;
                  }
                };
              }
            </script>
            <script>hljs.highlightAll();</script>
    </div>
    </div>
  </section>
  <footer class="footer">
    <div class="content has-text-centered">
      <p>
        Site built by <a href="https://github.com/tonybaloney">Anthony Shaw</a>. The source code is licensed
        <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
      </p>
    </div>
  </footer>
  </body>
</html>