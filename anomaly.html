<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Azure Cognitive Services - Anomaly Detection</title>
    <link rel="stylesheet" href="/res/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/languages/python.min.js"></script>
    
  </head>
  <body>
  <section class="main-content columns is-fullheight">
    <aside class="menu column is-2 is-narrow-mobile is-fullheight section">
        <p class="menu-label">
          Decision APIs
        </p>
        <ul class="menu-list">
          <li><a class="is-active">Anomaly Detector</a></li>
          <li><a>Content Moderator</a></li>
          <li><a>Personalizer</a></li>
        </ul>
        <p class="menu-label">
          Language APIs
        </p>
        <ul class="menu-list">
          <li><a>Language Understanding</a></li>
          <li><a>Q&amp;A Maker</a></li>
          <li><a>Text Analytics</a></li>
          <li><a>Translator</a></li>
        </ul>
        <p class="menu-label">
            Speech APIs
        </p>
        <ul class="menu-list">
            <li><a>Speech to Text</a></li>
            <li><a>Text to Speech</a></li>
            <li><a>Speech Translation</a></li>
            <li><a>Speaker Recognition</a></li>
        </ul>
        <p class="menu-label">
        Vision APIs
        </p>
          <ul class="menu-list">
            <li><a>Computer Vision</a></li>
            <li><a>Custom Vision</a></li>
            <li><a>Face API</a></li>
          </ul>
      </aside>
    <div class="container column is-10">
        <div class="section">
            <h1 class="title">
                Anomaly Detection
            </h1>
            <p>
              This experiment uses <a href="https://github.com/tonybaloney/cognitive-kitchen-sink/blob/main/api/data/koala-survey-sightings-data.csv">a dataset</a> of sightings of wild Koalas in Australia. This dataset captured the date and time of the sighting, along with the height the koala was at and the height of the tree (in meters).
              Azure Cognitive Services will process the dataset and train the model, then using your input, decide if the datapoint is an anomaly.
            </p>

            <p>
              This chart shows the percentage of the tree climbed (height of koala/height of tree) for each data point:

              <figure class="image is-fullwidth">
                <img src="/res/img/koala.png">
              </figure>
            </p>
            <p>Input a test value and see what the Anomaly Detection API thinks of your data capture:</p>
            <div class="field">
              <label class="label">Height of Koala (from ground)</label>
              <div class="control">
                <input id="height_of_koala" class="input" type="height_of_koala" placeholder="0">
              </div>
            </div>
            
            <div class="field">
              <label class="label">Height of tree</label>
              <div class="control">
                <input id="height_of_tree" class="input" type="height_of_tree" placeholder="10">
              </div>
            </div>

            <div class="control">
              <button class="button is-primary" onclick="verify()">Submit</button>
            </div>
            <br/>
            <article id="message-box" class="message is-primary" style="display: none;">
              <div class="message-header">
                <p>Result</p>
              </div>
              <div id="message-text" class="message-body">
              </div>
            </article>


       </div>
            <div class="section">
              <h2 class="title">Azure Functions Source Code</h2>
              <pre><code class="language-python">
import logging
import os
from datetime import datetime
from azure.core.exceptions import HttpResponseError
from azure.ai.anomalydetector import AnomalyDetectorClient
from azure.ai.anomalydetector.models import DetectRequest, TimeSeriesPoint, TimeGranularity
from azure.core.credentials import AzureKeyCredential
import pandas as pd

import azure.functions as func


def main(req: func.HttpRequest) -> func.HttpResponse:
    try:
        client = AnomalyDetectorClient(AzureKeyCredential(os.environ["ANOMALY_DETECTOR_KEY"]), os.environ["ANOMALY_DETECTOR_ENDPOINT"])

        try:
            height_of_koala = int(req.params.get('height_of_koala'))
            height_of_tree = int(req.params.get('height_of_tree'))
            if height_of_tree == 0:
                raise ValueError
        except ValueError as e:
            logging.exception(e)
            return func.HttpResponse(str(e), status_code=500)

        df = pd.read_csv(os.path.join("data", "koala-survey-sightings-data.csv"), encoding='utf-8', parse_dates=[['Date', 'Time']])

        # Drop entries with no height recorded.
        df.dropna(subset=['HeightOfKoalaInTree_m', 'HeightOfTree_m'], inplace=True)
        # Drop entries recorded at the exact same time
        df.drop_duplicates(subset = ["Date_Time"], inplace=True)
        # Calculate the percentage of the tree the Koala has climbed
        df['PercentageHeightClimbed'] = df['HeightOfKoalaInTree_m'] / df['HeightOfTree_m']
        # Turn into a timeseries
        series = [TimeSeriesPoint(timestamp=row[0], value=row[1]) for _, row in df[['Date_Time', 'PercentageHeightClimbed']].sort_values(by=['Date_Time']).iterrows()]
        
        # Add the user input
        series.append(TimeSeriesPoint(timestamp=datetime.now(), value=height_of_koala/height_of_tree))
        request = DetectRequest(series=series, granularity=TimeGranularity.NONE)
    
        response = client.detect_last_point(request)
    except HttpResponseError as e:
        msg = 'Error code: {} '.format(e.error.code) + 'Error message: {}'.format(e.error.message)
        logging.error(msg)
        return func.HttpResponse('Error code: {} '.format(e.error.code), status_code=500)
    except Exception as e:
        logging.exception(e)
        return func.HttpResponse(str(e), status_code=500)

    if response.is_anomaly:
        return func.HttpResponse(
            "Anomaly",
            status_code=200
        )
    else:
        return func.HttpResponse(
            "OK",
            status_code=200
        )
                
              </code></pre>
              <h4>The <a href="https://github.com/tonybaloney/cognitive-kitchen-sink/blob/main/api/AnomalyDetection/__init__.py">Source Code</a> is open source and licensed under MIT. <a href="https://github.com/tonybaloney/cognitive-kitchen-sink/blob/main/api/data/koala-survey-sightings-data.csv">Data</a> licensed under CC Creative Commons 3.0</h4>
            </div>
          </div>
            <script>
              function verify() {
                document.getElementById("message-box").style.display = 'none';

                var height_of_koala = parseInt(document.getElementById("height_of_koala").value);
                var height_of_tree = parseInt(document.getElementById("height_of_tree").value);

                var xhr = new XMLHttpRequest();
                xhr.open(
                  "GET",
                  "https://white-pebble-0101a6a10.azurestaticapps.net/api/AnomalyDetection?height_of_koala="+height_of_koala+"&height_of_tree="+height_of_tree,
                  true
                );
                xhr.send();
                xhr.onload = function () {
                  console.log(this.status);

                  document.getElementById("message-box").style.display = 'block';

                  if (this.status != 200){
                    document.getElementById("message-text").innerText = "Error with data";
                  } else {
                    document.getElementById("message-text").innerText = this.responseText;
                  }
                };
              }
            </script>
            <script>hljs.highlightAll();</script>
    </div>
    </div>
  </section>
  <footer class="footer">
    <div class="content has-text-centered">
      <p>
        Site built by <a href="https://github.com/tonybaloney">Anthony Shaw</a>. The source code is licensed
        <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.
      </p>
    </div>
  </footer>
  </body>
</html>